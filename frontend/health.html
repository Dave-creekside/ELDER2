<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELDER System Health</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0f1b;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00aaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #888;
            margin-bottom: 40px;
        }
        
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .health-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .health-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .health-card h2 {
            font-size: 1.2em;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .status-healthy {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid #00ff88;
        }
        
        .status-warning {
            background: rgba(255, 170, 0, 0.2);
            border: 2px solid #ffaa00;
        }
        
        .status-error {
            background: rgba(255, 0, 136, 0.2);
            border: 2px solid #ff0088;
        }
        
        .status-unknown {
            background: rgba(128, 128, 128, 0.2);
            border: 2px solid #808080;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #aaa;
        }
        
        .metric-value {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .refresh-btn {
            background: linear-gradient(45deg, #00ff88, #00aaff);
            border: none;
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .updating {
            animation: pulse 1s infinite;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff0040;
        }
        
        .connection-dot.connected {
            background: #00ff40;
        }
        
        .progress-container {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 8px;
            background: linear-gradient(45deg, #00ff88, #00aaff);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .btn-sleep {
            background: rgba(0, 170, 255, 0.2);
            border: 1px solid #00aaff;
            color: #00aaff;
            margin-top: 15px;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-sleep:hover {
            background: rgba(0, 170, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.2);
        }
        
        .active-sleep {
            color: #00ff88;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="connection-status">
        <span class="connection-dot" id="ws-status"></span>
        <span id="ws-text">Connecting...</span>
    </div>
    
    <div class="container">
        <h1>ðŸ§  ELDER System Health</h1>
        <p class="subtitle">Real-time monitoring of Elder's consciousness infrastructure</p>
        
        <div class="health-grid">
            <!-- 1. Hypergraph Brain (Neo4j) -->
            <div class="health-card">
                <h2>
                    <span class="status-icon status-unknown" id="graph-status">?</span>
                    Hypergraph Brain
                </h2>
                <div class="metric">
                    <span class="metric-label">Concepts</span>
                    <span class="metric-value" id="node-count">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Connections</span>
                    <span class="metric-value" id="edge-count">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Hyperedges</span>
                    <span class="metric-value" id="hyperedge-count">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Weight</span>
                    <span class="metric-value" id="avg-weight">-</span>
                </div>
                <!-- All Dimension Calculations -->
                <div class="metric" style="border-bottom: 2px solid rgba(0, 255, 136, 0.3); padding-bottom: 12px; margin-bottom: 12px;">
                    <span class="metric-label" style="font-weight: 700;">Fractal Dimensions</span>
                    <span class="metric-value" style="font-size: 0.9em; color: #888;">All Methods</span>
                </div>
                
                <!-- Box Counting -->
                <div class="metric">
                    <span class="metric-label">Box-Counting</span>
                    <span class="metric-value" id="dim-box-counting">-</span>
                </div>
                
                <!-- Correlation -->
                <div class="metric">
                    <span class="metric-label">Correlation</span>
                    <span class="metric-value" id="dim-correlation">-</span>
                </div>
                
                <!-- Information -->
                <div class="metric">
                    <span class="metric-label">Information</span>
                    <span class="metric-value" id="dim-information">-</span>
                </div>
                
                <!-- Sandbox -->
                <div class="metric">
                    <span class="metric-label">Sandbox</span>
                    <span class="metric-value" id="dim-sandbox">-</span>
                </div>
                
                <!-- Mass-Radius -->
                <div class="metric">
                    <span class="metric-label">Mass-Radius</span>
                    <span class="metric-value" id="dim-mass-radius">-</span>
                </div>
            </div>
            
            <!-- 2. Language Model -->
            <div class="health-card">
                <h2>
                    <span class="status-icon status-unknown" id="llm-status">?</span>
                    Language Model
                </h2>
                <div class="metric">
                    <span class="metric-label">Provider</span>
                    <span class="metric-value" id="llm-provider">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Model</span>
                    <span class="metric-value" id="llm-model">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Temperature</span>
                    <span class="metric-value" id="llm-temperature">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="llm-health">-</span>
                </div>
            </div>
            
            <!-- 3. Docker Services -->
            <div class="health-card">
                <h2>
                    <span class="status-icon status-unknown" id="docker-status">?</span>
                    Docker Services
                </h2>
                <div class="metric">
                    <span class="metric-label">Neo4j Database</span>
                    <span class="metric-value" id="neo4j-status">Checking...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Qdrant Vector DB</span>
                    <span class="metric-value" id="qdrant-status">Checking...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active Containers</span>
                    <span class="metric-value" id="container-count">-</span>
                </div>
            </div>
            
            <!-- 4. Vector Memory (Qdrant) -->
            <div class="health-card">
                <h2>
                    <span class="status-icon status-unknown" id="memory-status">?</span>
                    Vector Memory
                </h2>
                <div class="metric">
                    <span class="metric-label">Collections</span>
                    <span class="metric-value" id="collection-count">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memories Stored</span>
                    <span class="metric-value" id="memory-count">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Embedding Dimension</span>
                    <span class="metric-value" id="embedding-dim">-</span>
                </div>
            </div>
            
            <!-- System Performance -->
            <div class="health-card">
                <h2>
                    <span class="status-icon status-unknown" id="system-status">?</span>
                    System Performance
                </h2>
                <div class="metric">
                    <span class="metric-label">Dashboard</span>
                    <span class="metric-value" id="dashboard-status">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Tool Categories</span>
                    <span class="metric-value" id="tool-count">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Tools</span>
                    <span class="metric-value" id="total-tools">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value" id="uptime">-</span>
                </div>
            </div>
            
            <!-- Metabolic Status (Riemannian Consolidation) -->
            <div class="health-card">
                <h2>
                    <span class="status-icon status-unknown" id="metabolic-status">?</span>
                    Metabolic Status
                </h2>
                <div class="metric">
                    <span class="metric-label">Process</span>
                    <span class="metric-value" id="sleep-mode">Idle</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pending Traces</span>
                    <span class="metric-value" id="trace-count">0 / 50</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="trace-progress"></div>
                </div>
                <button class="btn-sleep" onclick="induceDeepSleep()">
                    ðŸ’¤ Induce Deep Sleep
                </button>
            </div>

            <!-- Recent Activity -->
            <div class="health-card">
                <h2>
                    <span class="status-icon status-healthy" id="activity-status">âœ“</span>
                    Recent Activity
                </h2>
                <div class="metric">
                    <span class="metric-label">Last Check</span>
                    <span class="metric-value" id="last-check">Never</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Auto-refresh</span>
                    <span class="metric-value">
                        <input type="checkbox" id="auto-refresh" disabled>
                        <small style="color: #666; margin-left: 5px;">Manual only</small>
                    </span>
                </div>
            </div>
        </div>
        
        <button class="refresh-btn" onclick="requestHealthStats(true)">
            ðŸ”„ Refresh Status
        </button>
    </div>
    
    <script>
        let socket = null;
        let autoRefreshInterval = null;
        let startTime = Date.now();
        let isVisible = false;
        let hasCalculatedHausdorff = false;
        let isRequestInProgress = false;
        let storedHausdorffDimension = null;
        let storedRSquared = null;
        
        function setStatus(elementId, status) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = 'status-icon';
            
            switch(status) {
                case 'healthy':
                    element.className += ' status-healthy';
                    element.textContent = 'âœ“';
                    break;
                case 'warning':
                    element.className += ' status-warning';
                    element.textContent = '!';
                    break;
                case 'error':
                    element.className += ' status-error';
                    element.textContent = 'âœ—';
                    break;
                default:
                    element.className += ' status-unknown';
                    element.textContent = '?';
            }
        }
        
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        
        function induceDeepSleep() {
            if (!confirm("Induce manual Deep Sleep cycle? This will temporarily pause responsiveness while weights are consolidated.")) {
                return;
            }
            
            fetch('/induce_sleep', { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    console.log("Sleep induction response:", d);
                    alert("Deep sleep cycle initiated. Monitor status in the Metabolic Status card.");
                    requestHealthStats(false);
                })
                .catch(e => console.error("Failed to induce sleep:", e));
        }

        function updateHealthData(data) {
            document.getElementById('last-check').textContent = new Date().toLocaleTimeString();
            
            // Handle errors
            if (data.error) {
                console.error('Health data error:', data.error);
                return;
            }
            
            // 1. Hypergraph Brain (Neo4j)
            if (data.graph) {
                const graph = data.graph;
                if (!graph.error) {
                    document.getElementById('node-count').textContent = graph.node_count || '0';
                    document.getElementById('edge-count').textContent = graph.edge_count || '0';
                    document.getElementById('hyperedge-count').textContent = graph.hyperedge_count || '0';
                    document.getElementById('avg-weight').textContent = 
                        graph.avg_weight ? graph.avg_weight.toFixed(3) : '0.000';
                    
                    // Handle ALL dimension calculations
                    if (graph.all_dimensions) {
                        // Display each dimension method
                        const methods = ['box_counting', 'correlation', 'information', 'sandbox', 'mass_radius'];
                        
                        methods.forEach(method => {
                            const elementId = `dim-${method.replace('_', '-')}`;
                            const element = document.getElementById(elementId);
                            
                            if (element && graph.all_dimensions[method]) {
                                const dim = graph.all_dimensions[method];
                                
                                if (dim.value !== null && dim.value !== undefined) {
                                    // Format: value (RÂ²)
                                    element.textContent = `${dim.value.toFixed(4)} (RÂ²: ${dim.r_squared.toFixed(3)})`;
                                    element.style.color = '#00ff88';  // Green for successful calculation
                                } else if (dim.error) {
                                    element.textContent = 'Error';
                                    element.style.color = '#ff0088';  // Red for error
                                } else {
                                    element.textContent = 'Failed';
                                    element.style.color = '#ffaa00';  // Orange for failed
                                }
                            } else {
                                // No data yet
                                if (element) {
                                    element.textContent = 'Calculating...';
                                    element.style.color = '#888';
                                }
                            }
                        });
                    } else {
                        // No dimension data yet - show placeholder
                        const methods = ['box-counting', 'correlation', 'information', 'sandbox', 'mass-radius'];
                        methods.forEach(method => {
                            const element = document.getElementById(`dim-${method}`);
                            if (element) {
                                element.textContent = 'Click refresh';
                                element.style.color = '#888';
                            }
                        });
                    }
                    
                    setStatus('graph-status', graph.node_count > 0 ? 'healthy' : 'warning');
                } else {
                    setStatus('graph-status', 'error');
                }
            }
            
            // 2. Language Model
            if (data.llm) {
                const llm = data.llm;
                document.getElementById('llm-provider').textContent = llm.provider || '-';
                document.getElementById('llm-model').textContent = llm.model || '-';
                document.getElementById('llm-temperature').textContent = 
                    llm.temperature !== undefined ? llm.temperature.toFixed(1) : '-';
                document.getElementById('llm-health').textContent = llm.status || '-';
                
                setStatus('llm-status', llm.status === 'Ready' ? 'healthy' : 'warning');
            }
            
            // 3. Docker Services
            if (data.docker) {
                const docker = data.docker;
                if (!docker.error) {
                    document.getElementById('neo4j-status').textContent = docker.neo4j || '-';
                    document.getElementById('qdrant-status').textContent = docker.qdrant || '-';
                    document.getElementById('container-count').textContent = docker.container_count || '0';
                    
                    const allRunning = docker.neo4j === 'Running' && docker.qdrant === 'Running';
                    setStatus('docker-status', allRunning ? 'healthy' : 'warning');
                } else {
                    setStatus('docker-status', 'error');
                    document.getElementById('neo4j-status').textContent = 'Error';
                    document.getElementById('qdrant-status').textContent = 'Error';
                }
            }
            
            // 4. Vector Memory (Qdrant)
            if (data.qdrant) {
                const qdrant = data.qdrant;
                if (!qdrant.error) {
                    document.getElementById('collection-count').textContent = qdrant.collection_count || '0';
                    document.getElementById('memory-count').textContent = qdrant.memory_count || '0';
                    document.getElementById('embedding-dim').textContent = qdrant.embedding_dim || '-';
                    
                    setStatus('memory-status', 'healthy');
                } else {
                    setStatus('memory-status', 'error');
                }
            }
            
            // 5. System Performance
            if (data.system) {
                const system = data.system;
                document.getElementById('dashboard-status').textContent = system.dashboard_status || '-';
                document.getElementById('tool-count').textContent = system.tool_count || '0';
                document.getElementById('total-tools').textContent = system.total_tools || '0';
                document.getElementById('uptime').textContent = 
                    system.uptime ? formatUptime(system.uptime) : '-';
                
                setStatus('system-status', system.dashboard_status === 'Connected' ? 'healthy' : 'warning');
            }

            // 6. Metabolic Status
            if (data.metabolic) {
                const metabolic = data.metabolic;
                const modeEl = document.getElementById('sleep-mode');
                const traceEl = document.getElementById('trace-count');
                const progressEl = document.getElementById('trace-progress');
                
                if (metabolic.deep_sleep_active) {
                    modeEl.textContent = 'DEEP SLEEP';
                    modeEl.className = 'metric-value active-sleep';
                    setStatus('metabolic-status', 'warning'); // Yellow for "busy"
                } else {
                    modeEl.textContent = 'Wake Cycle (Gathering)';
                    modeEl.className = 'metric-value';
                    setStatus('metabolic-status', 'healthy');
                }
                
                const count = metabolic.pending_traces || 0;
                const threshold = metabolic.trace_threshold || 50;
                traceEl.textContent = `${count} / ${threshold}`;
                
                const percentage = Math.min(100, (count / threshold) * 100);
                progressEl.style.width = `${percentage}%`;
            }
            
            document.querySelector('.refresh-btn').classList.remove('loading');
            isRequestInProgress = false;
        }
        
        function requestHealthStats(calculateHausdorff = null) {
            if (!socket || !socket.connected) {
                console.error('Socket not connected');
                return;
            }
            
            // Prevent overlapping requests
            if (isRequestInProgress) {
                console.log('Request already in progress, skipping...');
                return;
            }
            
            isRequestInProgress = true;
            document.querySelector('.refresh-btn').classList.add('loading');
            
            // Determine if we should calculate hausdorff
            const shouldCalculateHausdorff = calculateHausdorff !== null ? 
                calculateHausdorff : 
                !hasCalculatedHausdorff;
            
            socket.emit('get_health_stats', { 
                calculate_hausdorff: shouldCalculateHausdorff 
            });
            
            if (shouldCalculateHausdorff) {
                hasCalculatedHausdorff = true;
            }
        }
        
        function initializeSocket() {
            // Use relative URL for socket connection to support different ports/IPs
            socket = io({
                reconnectionDelay: 1000,
                reconnection: true,
                reconnectionAttempts: 10,
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                console.log('Connected to ELDER dashboard');
                document.getElementById('ws-status').classList.add('connected');
                document.getElementById('ws-text').textContent = 'Connected';
                
                // Request initial health stats
                requestHealthStats();
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from ELDER dashboard');
                document.getElementById('ws-status').classList.remove('connected');
                document.getElementById('ws-text').textContent = 'Disconnected';
            });
            
            socket.on('health_stats', (data) => {
                console.log('Received health stats:', data);
                updateHealthData(data);
            });
            
            socket.on('error', (error) => {
                console.error('Socket error:', error);
            });
        }
        
        // Auto-refresh toggle
        document.getElementById('auto-refresh').addEventListener('change', (e) => {
            if (e.target.checked && isVisible) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
        
        function startAutoRefresh() {
            if (autoRefreshInterval) return; // Already running
            
            // Use longer interval (10 seconds) and don't calculate hausdorff on auto-refresh
            autoRefreshInterval = setInterval(() => {
                if (isVisible && !isRequestInProgress) {
                    requestHealthStats(false); // false = don't calculate hausdorff
                }
            }, 10000);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Listen for visibility messages from parent
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'visibility') {
                isVisible = event.data.visible;
                
                if (isVisible) {
                    console.log('Health tab became visible');
                    
                    // Only request stats if we haven't calculated hausdorff yet
                    if (!hasCalculatedHausdorff || storedHausdorffDimension === null) {
                        requestHealthStats(true);
                    }
                    // Otherwise do nothing - user can manually refresh if they want updated stats
                } else {
                    console.log('Health tab became hidden');
                }
            }
        });
        
        // Initialize on load
        window.addEventListener('load', () => {
            initializeSocket();
            
            // Don't start auto-refresh immediately - wait for visibility
            // The parent will send a visibility message when this tab is shown
        });
    </script>
</body>
</html>
